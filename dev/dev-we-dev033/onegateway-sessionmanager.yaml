---
app: onegateway-sessionmanager
appVersion: v1

sessionManagerDeployment: true
debugEnvoyFilters: true

image:
  name: "kubeitglobalsvcauxacrwe.azurecr.io/test/sessionmanager"
  tag: "master-20240229.1"

additionalPodLabels:
  session-management: backend

service:
  containerPort: 8000

defaultRouting:
  enabled: true
  hosts:
   - ancris3-test.dev033.kubeit.dnv.com
  http:
    - match:
        - uri:
            exact: /session
      redirect:
        uri: /session/
    - match:
        - uri:
            prefix: /session/
  headers:
    request:
      add:
        x-appname: session
  retries:
    attempts: 3
    perTryTimeout: 15s

destinationRule:
  enabled: true

requestAuthentication:
  enabled: false

authorizationPolicy:
  enabled: true
  spec:
    action: ALLOW
    rules:
      - from:
        - source:
            namespaces:
              - istio-system
      - from:
        - source:
            namespaces:
              - onegateway

initContainers:
  - name: wait-for-redis
    image: owncloudci/wait-for
    args:
      - "-it"
      - "onegateway-sessionmanager-redis-master:6379"
      - "-t"
      - "30"
    resources:
      requests:
        cpu: "5m"
        memory: "32Mi"
      limits:
        memory: "128Mi"

health:
  livenessProbe:
    httpGet:
      path: /healthz
      port: 8000
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 1
    failureThreshold: 3

envs:
  - name: ASPNETCORE_ENVIRONMENT
    value: Development
  - name: ASPNETCORE_URLS
    value: http://*:8000
  - name: SESSION_MANAGER_ID
    value: ancris3
  - name: AUTHORITY
    value: https://login.veracity.com/te/dnvglb2cprod.onmicrosoft.com/B2C_1A_SignInWithADFSIdp/v2.0
  - name: SCOPE
    value: https://dnvglb2cprod.onmicrosoft.com/83054ebf-1d7b-43f5-82ad-b2bde84d7b75/user_impersonation
  - name: CLIENT_ID
    value: 1127167f-0330-447d-9744-586987c22603
  - name: REDIS_HOST
    value: onegateway-sessionmanager-redis-master
  - name: REDIS_PORT
    value: 6379
  - name: LOGIN_LANDING_URL
    value: "/"
  - name: LOGOUT_ENDPOINT
    value: https://www.veracity.com/auth/logout
  - name: REPLY_URL_SUFFIX
    value: veracity

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsGroup: 1654
  runAsNonRoot: true
  runAsUser: 1654

envsFrom:
  - name: CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: ancris3-session-manager
        key: client-secret
  - name: REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: onegateway-sessionmanager-redis
        key: redis-password

resources:
  requests:
    cpu: 250m
    memory: 64Mi
  limits:
    cpu: 500m
    memory: 128Mi

secretStore:
  enabled: true
  vaultUrl: "https://kubeit-dev-kv-sh-we.vault.azure.net/"

externalSecrets:
  - name: ancris3-session-manager
    refs:
      - keyName: client-secret
        kvSecretName: ancris3-session-dev033

redis:
  enabled: true
  global:
    imageRegistry: kubeitglobalsvcauxacrwe.azurecr.io
  architecture: standalone
  master:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 10m
        memory: 128Mi
      limits:
        memory: 256Mi
    containerSecurityContext:
      readOnlyRootFilesystem: true
  replica:
    persistence:
      enabled: false
  commonConfiguration: |-
    appendonly yes
    save ""
    loglevel verbose
