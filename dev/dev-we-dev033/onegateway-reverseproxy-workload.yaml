---
app: onegateway-reverseproxy-workload
appVersion: v1

image:
  name: "nginxinc/nginx-unprivileged"
  tag: "1.23.2"

service:
  containerPort: 8080

additionalPodLabels:
  session-management: frontend
  session-manager-name: onegateway-sessionmanager

env:
  - name: PROXY_PASS_HOST
    value: win-standard-workload.win-standard-workload.svc.cluster.local

# Simplests reverse proxy config - to be updated with security configs
configMap:
  enabled: true
  name: onegateway-reverseproxy-workload
  data: |
    default.conf.template: |
      server {
        listen 8080;
        server_name default;
        location / {
          proxy_set_header        Host $host;
          proxy_set_header        X-Real-IP $remote_addr;
          proxy_set_header        X-Forwarded-Host $http_host;
          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header        X-Forwarded-Proto $scheme;
          proxy_pass http://${PROXY_PASS_HOST}/;
        }
      }

volumeMounts:
  - name: configmap-volume
    mountPath: /etc/nginx/templates/default.conf.template
    subPath: default.conf.template

volumes:
  - name: configmap-volume
    configMap:
      name: onegateway-reverseproxy-workload

defaultRouting:
  enabled: true
  retries:
    attempts: 3
    perTryTimeout: 2s

resources:
  requests:
    cpu: 100m
    memory: 2Gi
  limits:
    cpu: 500m
    memory: 6Gi

destinationRule:
  enabled: true

authorizationPolicy:
  enabled: true
  spec:
    selector:
      matchLabels:
        app.kubernetes.io/name: onegateway-reverseproxy-workload
    action: ALLOW
    rules:
      - from:
          - source:
              namespaces: ["istio-system"]
              requestPrincipals: ["*"]

requestAuthentication:
  enabled: true
  jwtRules:
    - issuer: "https://login.veracity.com/a68572e3-63ce-4bc1-acdc-b64943502e9d/v2.0/"
      jwksUri: "https://login.veracity.com/te/a68572e3-63ce-4bc1-acdc-b64943502e9d/b2c_1a_signinwithadfsidp/discovery/v2.0/keys"
      audiences: [83054ebf-1d7b-43f5-82ad-b2bde84d7b75]
      forwardOriginalToken: true
