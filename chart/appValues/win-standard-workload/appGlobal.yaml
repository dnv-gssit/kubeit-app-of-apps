---
# https://kubernetes.io/docs/setup/production-environment/windows/user-guide-windows-containers/

# Application name
app: win-standard-workload    # Required

# Workload info
workload:
  type: standard      # Required - standard or onegateway
  state: stateful     # Required - stateful or stateless, for stateless mounting extra volumes is blocked (besides keyvault)

additionalPodAnnotations:
  # Istio sidecar is not working on Windows yet
  sidecar.istio.io/inject: "false"

image:
  repository: "mcr.microsoft.com/windows/servercore"
  tag: "ltsc2019"
  containerPort: 80

command:
  - powershell.exe
  - -command
  - "<#code used from https://gist.github.com/19WAS85/5424431#> ; $$listener = New-Object System.Net.HttpListener ; $$listener.Prefixes.Add('http://*:80/') ; $$listener.Start() ; $$callerCounts = @{} ; Write-Host('Listening at http://*:80/') ; while ($$listener.IsListening) { ;$$context = $$listener.GetContext() ;$$requestUrl = $$context.Request.Url ;$$clientIP = $$context.Request.RemoteEndPoint.Address ;$$response = $$context.Response ;Write-Host '' ;Write-Host('> {0}' -f $$requestUrl) ;  ;$$count = 1 ;$$k=$$callerCounts.Get_Item($$clientIP) ;if ($$k -ne $$null) { $$count += $$k } ;$$callerCounts.Set_Item($$clientIP, $$count) ;$$ip=(Get-NetAdapter | Get-NetIpAddress); $$header='<html><body><H1>Windows Container Web Server</H1>' ;$$callerCountsString='' ;$$callerCounts.Keys | % { $$callerCountsString+='<p>IP {0} callerCount {1} ' -f $$ip[1].IPAddress,$$callerCounts.Item($$_) } ;$$footer='</body></html>' ;$$content='{0}{1}{2}' -f $$header,$$callerCountsString,$$footer ;Write-Output $$content ;$$buffer = [System.Text.Encoding]::UTF8.GetBytes($$content) ;$$response.ContentLength64 = $$buffer.Length ;$$response.OutputStream.Write($$buffer, 0, $$buffer.Length) ;$$response.Close() ;$$responseStatus = $$response.StatusCode ;Write-Host('< {0}' -f $$responseStatus)  } ;"

defaultRouting:
  enabled: true
  kubeitDefaultHosts:
    hostsPrefix: "www-win"      # Application will be available under: https://${hostsPrefix}-${tenantName}.${env}.kubeit.dnv.com/, instead of https://${app}-${tenantName}.${env}.kubeit.dnv.com/
  rewriteUrlPrefix:
    enabled: false
  allHosts: false
  redirectOnNoTrailingSlash: false
  catchAll: true

serviceAccount:
  # Specifies whether a ServiceAccount should be created
  create: true

authorizationPolicy:
  enabled: false
requestAuthentication:
  enabled: false

# TODO: add volumes
# volumes:

# Be Aware! Security contexts configuration is specific to Docker Image, if your workload is not spinning up try disabling settings below and after check what needs to be changed.
securityContext:
  # fsGroup: 1000  #Not supported on windows
  # runAsUser: 1000 #Not supported on windows
  runAsNonRoot: true

containerSecurityContext:
  # capabilities:  #Not supported on windows
  #   drop:
  #     - ALL
  # readOnlyRootFilesystem: true  #Not supported on windows
  runAsNonRoot: true

nodeSelector:
  kubernetes.io/os: windows

tolerations:
  - key: "sku"
    value: "Windows"
    effect: "NoSchedule"
